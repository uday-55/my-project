{% extends "base.html" %}

{% block title %}Farmer Dashboard - Oilseed Platform{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/leaflet.css') }}" />
<style>
    .language-selector {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .voice-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .voice-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .voice-btn.listening {
        background: #e74c3c;
        color: white;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    #map {
        height: 500px;
        border-radius: 12px;
        margin-top: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .map-search {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .map-legend {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1.5rem;
        font-weight: 600;
    }
    
    .legend-marker {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    @keyframes markerDrop {
        0% {
            transform: translateY(-200px) scale(0);
            opacity: 0;
        }
        60% {
            transform: translateY(10px) scale(1.1);
            opacity: 1;
        }
        80% {
            transform: translateY(-5px) scale(0.95);
        }
        100% {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }
    
    @keyframes markerPulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }
    }
    
    .custom-popup .leaflet-popup-content-wrapper {
        border-radius: 12px;
        padding: 0;
    }
    
    .custom-popup .leaflet-popup-content {
        margin: 12px;
    }
    
    .marker-pin:hover {
        transform: scale(1.2) !important;
        transition: transform 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="language-selector">
    <label style="margin-right: 0.5rem; font-weight: 600;">
        <i class="fas fa-language"></i> Language:
    </label>
    <select id="languageSelect" onchange="changeLanguage()" class="form-control" style="display: inline-block; width: auto;">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
    </select>
</div>

<h1 style="color: #2ecc71; margin-bottom: 2rem;">
    <i class="fas fa-tractor"></i> <span data-translate="farmer_dashboard">Farmer Dashboard</span>
</h1>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <i class="fas fa-chart-line"></i> <span data-translate="ai_price_predictor">AI Price Predictor</span>
            <button onclick="toggleVoice()" class="voice-btn" id="voiceBtn" style="float: right; font-size: 0.9rem;">
                <i class="fas fa-microphone"></i> <span data-translate="voice_control">Voice Control</span>
            </button>
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="select_crop">Select Crop Type</label>
            <select id="cropType" class="form-control">
                <option value="soybean" data-translate="soybean">Soybean</option>
                <option value="groundnut" data-translate="groundnut">Groundnut</option>
                <option value="mustard" data-translate="mustard">Mustard</option>
                <option value="sunflower" data-translate="sunflower">Sunflower</option>
            </select>
        </div>
        <button onclick="predictPrice()" class="btn btn-primary">
            <i class="fas fa-brain"></i> <span data-translate="predict_prices">Predict Prices</span>
        </button>
        <div class="voice-controls">
            <div id="voiceStatus" style="color: #666; font-size: 0.9rem;"></div>
        </div>
        <div id="priceChart" style="margin-top: 2rem;"></div>
        <div id="priceData" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-cloud-sun"></i> <span data-translate="crop_advisory">Crop Advisory</span>
        </div>
        <div id="advisoryContent">
            <p style="color: #666;" data-translate="select_crop_info">Select a crop and click "Predict Prices" to see advisory information</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-dollar-sign"></i> <span data-translate="sell_crop">Sell Your Crop</span>
    </div>
    <div class="grid grid-2">
        <div class="form-group">
            <label class="form-label" data-translate="your_name">Your Name</label>
            <input type="text" id="farmerName" class="form-control" placeholder="Enter your name" data-translate-placeholder="enter_name">
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="crop_type">Crop Type</label>
            <select id="sellCropType" class="form-control">
                <option value="soybean" data-translate="soybean">Soybean</option>
                <option value="groundnut" data-translate="groundnut">Groundnut</option>
                <option value="mustard" data-translate="mustard">Mustard</option>
                <option value="sunflower" data-translate="sunflower">Sunflower</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="quantity">Quantity (kg)</label>
            <input type="number" id="quantity" class="form-control" placeholder="Enter quantity" min="0" data-translate-placeholder="enter_quantity">
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="price">Price (‚Çπ/quintal)</label>
            <input type="number" id="price" class="form-control" placeholder="Enter price" min="0" data-translate-placeholder="enter_price">
        </div>
    </div>
    <button onclick="sellCrop()" class="btn btn-primary">
        <i class="fas fa-shopping-cart"></i> <span data-translate="sell_crop_btn">Sell Crop</span>
    </button>
    <div id="sellResult" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-trophy"></i> <span data-translate="your_badges">Your Badges</span>
    </div>
    <div id="badgesContainer">
        <p style="color: #666;" data-translate="earn_badges">Complete transactions to earn badges!</p>
    </div>
</div>

<div class="card" id="mapSection" style="scroll-margin-top: 80px;">
    <div class="card-header" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
        <i class="fas fa-map-marked-alt"></i> <span data-translate="marketplace_map">Marketplace Map - Find Farmers, Buyers & Warehouses</span>
        <div style="float: right; font-size: 0.9rem;">
            <i class="fas fa-map-pin"></i> Live Locations
        </div>
    </div>
    <div class="map-search">
        <input type="text" id="mapSearch" class="form-control" placeholder="Search for farms, buyers, or warehouses..." onkeyup="searchMap()" data-translate-placeholder="search_map">
    </div>
    <div id="map" style="min-height: 500px; background: #e0f2f1;">
        <div style="text-align: center; padding: 200px 20px; color: #666;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #2ecc71;"></i>
            <p style="margin-top: 1rem;">Loading interactive map...</p>
        </div>
    </div>
    <div class="map-legend">
        <div class="legend-item">
            <div class="legend-marker" style="background: #2ecc71;"></div>
            <span data-translate="farmers">üü¢ Farmers</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #3498db;"></div>
            <span data-translate="buyers">üîµ Buyers</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #e67e22;"></div>
            <span data-translate="warehouses">üü† Marketplaces/Warehouses</span>
        </div>
    </div>
</div>

<div class="card" style="position: fixed; bottom: 20px; right: 20px; width: 350px; max-height: 500px; z-index: 999; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
    <div class="card-header" style="cursor: pointer;" onclick="toggleChat()">
        <i class="fas fa-robot"></i> <span data-translate="ai_assistant">AI Assistant</span>
        <span style="float: right;"><i class="fas fa-chevron-down" id="chatToggle"></i></span>
    </div>
    <div id="chatBox" style="display: block;">
        <div id="chatMessages" style="height: 250px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9;">
            <div class="alert alert-info">
                <strong data-translate="ai_assistant">AI Assistant:</strong> <span data-translate="ai_greeting">Hello! I'm here to help with oilseed farming, pricing, weather, and more. Ask me anything!</span>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="chatInput" class="form-control" placeholder="Ask about prices, weather, pests..." onkeypress="if(event.key==='Enter') sendMessage()" data-translate-placeholder="chat_placeholder">
            <button onclick="sendMessage()" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button onclick="voiceChat()" class="btn btn-secondary">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>
</div>

<div style="margin-bottom: 2rem;">
    <a href="/download-report?type=farmer" class="btn btn-secondary">
        <i class="fas fa-download"></i> <span data-translate="download_report">Download My Report (PDF)</span>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
<script>
let currentPredictions = [];
let map;
let markers = [];
let currentLanguage = 'en';
let recognition;
let isListening = false;

const translations = {
    en: {
        farmer_dashboard: "Farmer Dashboard",
        ai_price_predictor: "AI Price Predictor",
        voice_control: "Voice Control",
        select_crop: "Select Crop Type",
        predict_prices: "Predict Prices",
        crop_advisory: "Crop Advisory",
        select_crop_info: "Select a crop and click 'Predict Prices' to see advisory information",
        sell_crop: "Sell Your Crop",
        your_name: "Your Name",
        crop_type: "Crop Type",
        quantity: "Quantity (kg)",
        price: "Price (‚Çπ/quintal)",
        sell_crop_btn: "Sell Crop",
        your_badges: "Your Badges",
        earn_badges: "Complete transactions to earn badges!",
        marketplace_map: "Marketplace Map - Find Farmers, Buyers & Warehouses",
        farmers: "üü¢ Farmers",
        buyers: "üîµ Buyers",
        warehouses: "üü† Marketplaces/Warehouses",
        ai_assistant: "AI Assistant",
        ai_greeting: "Hello! I'm here to help with oilseed farming, pricing, weather, and more. Ask me anything!",
        download_report: "Download My Report (PDF)",
        soybean: "Soybean",
        groundnut: "Groundnut",
        mustard: "Mustard",
        sunflower: "Sunflower",
        enter_name: "Enter your name",
        enter_quantity: "Enter quantity",
        enter_price: "Enter price",
        search_map: "Search for farms, buyers, or warehouses...",
        chat_placeholder: "Ask about prices, weather, pests...",
        price_forecast: "7-Day Price Forecast",
        date: "Date",
        weather: "Weather",
        pest_risk: "Pest Risk",
        sowing_time: "Sowing Time",
        harvest_time: "Harvest Time",
        tip: "Tip",
        success: "Success!",
        congratulations: "Congratulations! Your badges:",
        fill_all_fields: "Please fill in all fields",
        price_per_quintal: "Price (‚Çπ/quintal)",
        price_prediction_title: "Price Prediction - Next 7 Days"
    },
    hi: {
        farmer_dashboard: "‡§ï‡§ø‡§∏‡§æ‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
        ai_price_predictor: "‡§è‡§Ü‡§à ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§ï‡•ç‡§§‡§æ",
        voice_control: "‡§Ü‡§µ‡§æ‡§ú ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£",
        select_crop: "‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç",
        predict_prices: "‡§ï‡•Ä‡§Æ‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡•á‡§Ç",
        crop_advisory: "‡§´‡§∏‡§≤ ‡§∏‡§≤‡§æ‡§π",
        select_crop_info: "‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§≤‡§æ‡§π ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è '‡§ï‡•Ä‡§Æ‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡•á‡§Ç' ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç",
        sell_crop: "‡§Ö‡§™‡§®‡•Ä ‡§´‡§∏‡§≤ ‡§¨‡•á‡§ö‡•á‡§Ç",
        your_name: "‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ",
        crop_type: "‡§´‡§∏‡§≤ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
        quantity: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡§ø‡§≤‡•ã)",
        price: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤)",
        sell_crop_btn: "‡§´‡§∏‡§≤ ‡§¨‡•á‡§ö‡•á‡§Ç",
        your_badges: "‡§Ü‡§™‡§ï‡•á ‡§¨‡•à‡§ú",
        earn_badges: "‡§¨‡•à‡§ú ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç!",
        marketplace_map: "‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞ - ‡§ï‡§ø‡§∏‡§æ‡§®, ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞ ‡§î‡§∞ ‡§ó‡•ã‡§¶‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç",
        farmers: "üü¢ ‡§ï‡§ø‡§∏‡§æ‡§®",
        buyers: "üîµ ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞",
        warehouses: "üü† ‡§¨‡§æ‡§ú‡§æ‡§∞/‡§ó‡•ã‡§¶‡§æ‡§Æ",
        ai_assistant: "‡§è‡§Ü‡§à ‡§∏‡§π‡§æ‡§Ø‡§ï",
        ai_greeting: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§§‡§ø‡§≤‡§π‡§® ‡§ï‡•Ä ‡§ñ‡•á‡§§‡•Ä, ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£, ‡§Æ‡•å‡§∏‡§Æ ‡§î‡§∞ ‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§π‡•Ç‡§Å‡•§ ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!",
        download_report: "‡§Æ‡•á‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (PDF)",
        soybean: "‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®",
        groundnut: "‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä",
        mustard: "‡§∏‡§∞‡§∏‡•ã‡§Ç",
        sunflower: "‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä",
        enter_name: "‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
        enter_quantity: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
        enter_price: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
        search_map: "‡§ñ‡•á‡§§‡•ã‡§Ç, ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•ã‡§Ç ‡§Ø‡§æ ‡§ó‡•ã‡§¶‡§æ‡§Æ‡•ã‡§Ç ‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§ï‡§∞‡•á‡§Ç...",
        chat_placeholder: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø, ‡§Æ‡•å‡§∏‡§Æ, ‡§ï‡•Ä‡§ü‡•ã‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç...",
        price_forecast: "7-‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§®",
        date: "‡§§‡§æ‡§∞‡•Ä‡§ñ",
        weather: "‡§Æ‡•å‡§∏‡§Æ",
        pest_risk: "‡§ï‡•Ä‡§ü ‡§ú‡•ã‡§ñ‡§ø‡§Æ",
        sowing_time: "‡§¨‡•Å‡§µ‡§æ‡§à ‡§ï‡§æ ‡§∏‡§Æ‡§Ø",
        harvest_time: "‡§ï‡§ü‡§æ‡§à ‡§ï‡§æ ‡§∏‡§Æ‡§Ø",
        tip: "‡§∏‡•Å‡§ù‡§æ‡§µ",
        success: "‡§∏‡§´‡§≤‡§§‡§æ!",
        congratulations: "‡§¨‡§ß‡§æ‡§à ‡§π‡•ã! ‡§Ü‡§™‡§ï‡•á ‡§¨‡•à‡§ú:",
        fill_all_fields: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç",
        price_per_quintal: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤)",
        price_prediction_title: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§® - ‡§Ö‡§ó‡§≤‡•á 7 ‡§¶‡§ø‡§®"
    },
    te: {
        farmer_dashboard: "‡∞∞‡±à‡∞§‡±Å ‡∞°‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç",
        ai_price_predictor: "AI ‡∞ß‡∞∞ ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ",
        voice_control: "‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞®‡∞ø‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞£",
        select_crop: "‡∞™‡∞Ç‡∞ü ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø",
        predict_prices: "‡∞ß‡∞∞‡∞≤‡∞®‡±Å ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ ‡∞µ‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
        crop_advisory: "‡∞™‡∞Ç‡∞ü ‡∞∏‡∞≤‡∞π‡∞æ",
        ai_assistant: "AI ‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å",
        download_report: "‡∞®‡∞æ ‡∞®‡∞ø‡∞µ‡±á‡∞¶‡∞ø‡∞ï‡∞®‡±Å ‡∞°‡±å‡∞®‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø (PDF)",
        soybean: "‡∞∏‡±ã‡∞Ø‡∞æ‡∞¨‡±Ä‡∞®‡±ç",
        groundnut: "‡∞µ‡±á‡∞∞‡±Å‡∞∂‡±Ü‡∞®‡∞ó",
        mustard: "‡∞Ü‡∞µ‡∞æ‡∞≤‡±Å",
        sunflower: "‡∞™‡±ä‡∞¶‡±ç‡∞¶‡±Å‡∞§‡∞ø‡∞∞‡±Å‡∞ó‡±Å‡∞°‡±Å",
        sell_crop: "‡∞Æ‡±Ä ‡∞™‡∞Ç‡∞ü‡∞®‡±Å ‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞Ç‡∞°‡∞ø",
        your_name: "‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å",
        crop_type: "‡∞™‡∞Ç‡∞ü ‡∞∞‡∞ï‡∞Ç",
        quantity: "‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç (‡∞ï‡∞ø‡∞≤‡±ã‡∞≤‡±Å)",
        price: "‡∞ß‡∞∞ (‚Çπ/‡∞ï‡±ç‡∞µ‡∞ø‡∞Ç‡∞ü‡∞æ‡∞≤‡±ç)",
        marketplace_map: "‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç - ‡∞∞‡±à‡∞§‡±Å‡∞≤‡±Å, ‡∞ï‡±ä‡∞®‡±Å‡∞ó‡±ã‡∞≤‡±Å‡∞¶‡∞æ‡∞∞‡±Å‡∞≤‡±Å & ‡∞ó‡∞ø‡∞°‡±ç‡∞°‡∞Ç‡∞ó‡±Å‡∞≤‡±Å",
        farmers: "üü¢ ‡∞∞‡±à‡∞§‡±Å‡∞≤‡±Å",
        buyers: "üîµ ‡∞ï‡±ä‡∞®‡±Å‡∞ó‡±ã‡∞≤‡±Å‡∞¶‡∞æ‡∞∞‡±Å‡∞≤‡±Å",
        warehouses: "üü† ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç‚Äå‡∞≤‡±Å/‡∞ó‡∞ø‡∞°‡±ç‡∞°‡∞Ç‡∞ó‡±Å‡∞≤‡±Å",
        weather: "‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç",
        pest_risk: "‡∞§‡±Ü‡∞ó‡±Å‡∞≤‡±Å ‡∞™‡±ç‡∞∞‡∞Æ‡∞æ‡∞¶‡∞Ç",
        sowing_time: "‡∞µ‡∞ø‡∞§‡±ç‡∞§‡±á ‡∞∏‡∞Æ‡∞Ø‡∞Ç",
        harvest_time: "‡∞ï‡±ã‡∞§ ‡∞∏‡∞Æ‡∞Ø‡∞Ç",
        tip: "‡∞ö‡∞ø‡∞ü‡±ç‡∞ï‡∞æ",
        price_forecast: "7-‡∞∞‡±ã‡∞ú‡±Å‡∞≤ ‡∞ß‡∞∞ ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ",
        date: "‡∞§‡±á‡∞¶‡±Ä",
        price_per_quintal: "‡∞ß‡∞∞ (‚Çπ/‡∞ï‡±ç‡∞µ‡∞ø‡∞Ç‡∞ü‡∞æ‡∞≤‡±ç)",
        price_prediction_title: "‡∞ß‡∞∞ ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ - ‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø 7 ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡±Å"
    },
    ta: {
        farmer_dashboard: "‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ‡Æø ‡Æü‡Ææ‡Æ∑‡Øç‡Æ™‡Øã‡Æ∞‡Øç‡Æü‡ØÅ",
        ai_price_predictor: "AI ‡Æµ‡Æø‡Æ≤‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
        voice_control: "‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç ‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ØÅ",
        select_crop: "‡Æ™‡ÆØ‡Æø‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
        predict_prices: "‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
        crop_advisory: "‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà",
        ai_assistant: "AI ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç",
        download_report: "‡Æé‡Æ©‡Æ§‡ØÅ ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (PDF)",
        soybean: "‡Æö‡Øã‡ÆØ‡Ææ",
        groundnut: "‡Æ®‡Æø‡Æ≤‡Æï‡Øç‡Æï‡Æü‡Æ≤‡Øà",
        mustard: "‡Æï‡Æü‡ØÅ‡Æï‡ØÅ",
        sunflower: "‡Æö‡ØÇ‡Æ∞‡Æø‡ÆØ‡Æï‡Ææ‡Æ®‡Øç‡Æ§‡Æø",
        sell_crop: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øà ‡Æµ‡Æø‡Æ±‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
        your_name: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç",
        crop_type: "‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æµ‡Æï‡Øà",
        quantity: "‡ÆÖ‡Æ≥‡Æµ‡ØÅ (‡Æï‡Æø‡Æ≤‡Øã)",
        price: "‡Æµ‡Æø‡Æ≤‡Øà (‚Çπ/‡Æï‡ØÅ‡Æµ‡Æø‡Æ£‡Øç‡Æü‡Ææ‡Æ≤‡Øç)",
        marketplace_map: "‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡Æµ‡Æ∞‡Øà‡Æ™‡Æü‡ÆÆ‡Øç - ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ‡Æø‡Æï‡Æ≥‡Øç, ‡Æµ‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ™‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç & ‡Æï‡Æø‡Æü‡Æô‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç",
        farmers: "üü¢ ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ‡Æø‡Æï‡Æ≥‡Øç",
        buyers: "üîµ ‡Æµ‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ™‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç",
        warehouses: "üü† ‡Æö‡Æ®‡Øç‡Æ§‡Øà‡Æï‡Æ≥‡Øç/‡Æï‡Æø‡Æü‡Æô‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç",
        weather: "‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà",
        pest_risk: "‡Æ™‡ØÇ‡Æö‡Øç‡Æö‡Æø ‡ÆÜ‡Æ™‡Æ§‡Øç‡Æ§‡ØÅ",
        sowing_time: "‡Æµ‡Æø‡Æ§‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç",
        harvest_time: "‡ÆÖ‡Æ±‡ØÅ‡Æµ‡Æü‡Øà ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç",
        tip: "‡Æâ‡Æ§‡Æµ‡Æø‡Æï‡Øç‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
        price_forecast: "7-‡Æ®‡Ææ‡Æ≥‡Øç ‡Æµ‡Æø‡Æ≤‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
        date: "‡Æ§‡Øá‡Æ§‡Æø",
        price_per_quintal: "‡Æµ‡Æø‡Æ≤‡Øà (‚Çπ/‡Æï‡ØÅ‡Æµ‡Æø‡Æ£‡Øç‡Æü‡Ææ‡Æ≤‡Øç)",
        price_prediction_title: "‡Æµ‡Æø‡Æ≤‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ - ‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§ 7 ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Øç"
    }
};

function getTranslation(key) {
    return translations[currentLanguage] && translations[currentLanguage][key] 
        ? translations[currentLanguage][key] 
        : translations['en'][key] || key;
}

function changeLanguage() {
    currentLanguage = document.getElementById('languageSelect').value;
    
    // Update text content
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            element.textContent = translations[currentLanguage][key];
        }
    });
    
    // Update placeholders
    document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            element.placeholder = translations[currentLanguage][key];
        }
    });
    
    // Update select options
    document.querySelectorAll('select option[data-translate]').forEach(option => {
        const key = option.getAttribute('data-translate');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            option.textContent = translations[currentLanguage][key];
        }
    });
    
    // Re-render advisory and price data if they exist
    if (currentPredictions && currentPredictions.length > 0) {
        renderPriceData(currentPredictions);
    }
    if (window.currentAdvisory) {
        renderAdvisory(window.currentAdvisory);
    }
}

function initVoice() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript.toLowerCase();
            document.getElementById('voiceStatus').textContent = `Heard: "${transcript}"`;
            processVoiceCommand(transcript);
        };
        
        recognition.onerror = function(event) {
            document.getElementById('voiceStatus').textContent = 'Error: ' + event.error;
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
        };
        
        recognition.onend = function() {
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
        };
    } else {
        document.getElementById('voiceStatus').textContent = 'Voice recognition not supported';
    }
}

function toggleVoice() {
    if (!recognition) {
        initVoice();
    }
    
    if (isListening) {
        recognition.stop();
        isListening = false;
        document.getElementById('voiceBtn').classList.remove('listening');
        document.getElementById('voiceStatus').textContent = '';
    } else {
        recognition.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
        recognition.start();
        isListening = true;
        document.getElementById('voiceBtn').classList.add('listening');
        document.getElementById('voiceStatus').textContent = 'Listening...';
    }
}

function processVoiceCommand(command) {
    if (command.includes('soybean') || command.includes('‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®')) {
        document.getElementById('cropType').value = 'soybean';
        predictPrice();
    } else if (command.includes('groundnut') || command.includes('‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä')) {
        document.getElementById('cropType').value = 'groundnut';
        predictPrice();
    } else if (command.includes('mustard') || command.includes('‡§∏‡§∞‡§∏‡•ã‡§Ç')) {
        document.getElementById('cropType').value = 'mustard';
        predictPrice();
    } else if (command.includes('sunflower') || command.includes('‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä')) {
        document.getElementById('cropType').value = 'sunflower';
        predictPrice();
    } else if (command.includes('price') || command.includes('predict') || command.includes('‡§ï‡•Ä‡§Æ‡§§')) {
        predictPrice();
    } else {
        speak('Command not recognized. Try saying: soybean price, mustard price, or groundnut price');
    }
}

function voiceChat() {
    if (!recognition) initVoice();
    
    const voiceRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    voiceRecognition.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
    voiceRecognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('chatInput').value = transcript;
        sendMessage();
    };
    voiceRecognition.start();
}

function speak(text) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
        speechSynthesis.speak(utterance);
    }
}

function initMap() {
    try {
        console.log('Starting map initialization...');
        console.log('Leaflet available:', typeof L !== 'undefined');
        
        if (typeof L === 'undefined') {
            console.error('Leaflet library not loaded!');
            document.getElementById('map').innerHTML = '<div style="text-align: center; padding: 200px 20px; color: #e74c3c;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem;"></i><p style="margin-top: 1rem;">Map library failed to load. Please refresh the page.</p></div>';
            return;
        }
        
        map = L.map('map', {
            zoomControl: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            touchZoom: true
        }).setView([20.5937, 78.9629], 5);
        
        console.log('Map object created:', map);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18,
        minZoom: 4
    }).addTo(map);
    
    const locations = [
        // North India Farmers
        {type: 'farmer', name: 'Ram Kumar Farm', lat: 28.6139, lng: 77.2090, crop: 'Soybean, Mustard', location: 'Delhi', icon: 'üü¢'},
        {type: 'farmer', name: 'Punjab Agro Farm', lat: 30.7333, lng: 76.7794, crop: 'Mustard, Sunflower', location: 'Chandigarh', icon: 'üü¢'},
        {type: 'farmer', name: 'Haryana Oilseeds', lat: 29.0588, lng: 76.0856, crop: 'Mustard', location: 'Rohtak', icon: 'üü¢'},
        {type: 'farmer', name: 'Rajasthan Farms', lat: 26.9124, lng: 75.7873, crop: 'Mustard, Groundnut', location: 'Jaipur', icon: 'üü¢'},
        
        // West India Farmers
        {type: 'farmer', name: 'Lakshmi Agro', lat: 19.0760, lng: 72.8777, crop: 'Groundnut', location: 'Mumbai', icon: 'üü¢'},
        {type: 'farmer', name: 'Gujarat Oilseeds Co', lat: 23.0225, lng: 72.5714, crop: 'Groundnut, Soybean', location: 'Ahmedabad', icon: 'üü¢'},
        {type: 'farmer', name: 'Nashik Valley Farms', lat: 19.9975, lng: 73.7898, crop: 'Soybean', location: 'Nashik', icon: 'üü¢'},
        
        // South India Farmers
        {type: 'farmer', name: 'Suresh Organic Farm', lat: 13.0827, lng: 80.2707, crop: 'Sunflower, Groundnut', location: 'Chennai', icon: 'üü¢'},
        {type: 'farmer', name: 'Karnataka Agro', lat: 12.9716, lng: 77.5946, crop: 'Sunflower', location: 'Bangalore', icon: 'üü¢'},
        {type: 'farmer', name: 'Kerala Oilseed Farm', lat: 10.8505, lng: 76.2711, crop: 'Groundnut', location: 'Palakkad', icon: 'üü¢'},
        {type: 'farmer', name: 'Guntur Farms', lat: 16.3067, lng: 80.4365, crop: 'Sunflower, Groundnut', location: 'Guntur', icon: 'üü¢'},
        
        // Central India Farmers
        {type: 'farmer', name: 'Ganesh Farms', lat: 17.3850, lng: 78.4867, crop: 'Soybean', location: 'Hyderabad', icon: 'üü¢'},
        {type: 'farmer', name: 'MP Soybean Hub', lat: 23.2599, lng: 77.4126, crop: 'Soybean', location: 'Bhopal', icon: 'üü¢'},
        {type: 'farmer', name: 'Vidarbha Oilseeds', lat: 21.1458, lng: 79.0882, crop: 'Soybean, Sunflower', location: 'Nagpur', icon: 'üü¢'},
        
        // East India Farmers
        {type: 'farmer', name: 'Rajesh Crops', lat: 22.5726, lng: 88.3639, crop: 'Mustard, Groundnut', location: 'Kolkata', icon: 'üü¢'},
        {type: 'farmer', name: 'Odisha Agro Farm', lat: 20.2961, lng: 85.8245, crop: 'Mustard', location: 'Bhubaneswar', icon: 'üü¢'},
        {type: 'farmer', name: 'Bihar Oilseeds', lat: 25.5941, lng: 85.1376, crop: 'Mustard, Sunflower', location: 'Patna', icon: 'üü¢'},
        
        // Buyers
        {type: 'buyer', name: 'ABC Oil Mills', lat: 28.4595, lng: 77.0266, demand: 'All Oilseeds', location: 'Gurgaon', icon: 'üîµ'},
        {type: 'buyer', name: 'Premium Processors', lat: 12.9716, lng: 77.5946, demand: 'Groundnut, Sunflower', location: 'Bangalore', icon: 'üîµ'},
        {type: 'buyer', name: 'Golden Oil Industries', lat: 23.0225, lng: 72.5714, demand: 'Soybean', location: 'Ahmedabad', icon: 'üîµ'},
        {type: 'buyer', name: 'Mumbai Oil Traders', lat: 19.0760, lng: 72.8777, demand: 'All Oilseeds', location: 'Mumbai', icon: 'üîµ'},
        {type: 'buyer', name: 'South India Mills', lat: 13.0827, lng: 80.2707, demand: 'Sunflower, Groundnut', location: 'Chennai', icon: 'üîµ'},
        {type: 'buyer', name: 'Bengal Processors', lat: 22.5726, lng: 88.3639, demand: 'Mustard', location: 'Kolkata', icon: 'üîµ'},
        {type: 'buyer', name: 'Telangana Oil Co', lat: 17.3850, lng: 78.4867, demand: 'Soybean, Sunflower', location: 'Hyderabad', icon: 'üîµ'},
        
        // Warehouses
        {type: 'warehouse', name: 'Central Warehouse Delhi', lat: 28.7041, lng: 77.1025, capacity: '5000 tonnes', location: 'Delhi', icon: 'üü†'},
        {type: 'warehouse', name: 'Maharashtra Storage Hub', lat: 19.2183, lng: 72.9781, capacity: '8000 tonnes', location: 'Navi Mumbai', icon: 'üü†'},
        {type: 'warehouse', name: 'South India Depot', lat: 13.0569, lng: 80.2425, capacity: '6000 tonnes', location: 'Chennai', icon: 'üü†'},
        {type: 'warehouse', name: 'Telangana FPO Center', lat: 17.4474, lng: 78.3742, capacity: '4500 tonnes', location: 'Secunderabad', icon: 'üü†'},
        {type: 'warehouse', name: 'Gujarat Storage', lat: 23.0300, lng: 72.5500, capacity: '7000 tonnes', location: 'Ahmedabad', icon: 'üü†'},
        {type: 'warehouse', name: 'West Bengal Hub', lat: 22.5800, lng: 88.4200, capacity: '5500 tonnes', location: 'Kolkata', icon: 'üü†'},
        {type: 'warehouse', name: 'Karnataka Storage', lat: 12.9800, lng: 77.6000, capacity: '6500 tonnes', location: 'Bangalore', icon: 'üü†'},
        {type: 'warehouse', name: 'MP Central Hub', lat: 23.2700, lng: 77.4100, capacity: '7500 tonnes', location: 'Bhopal', icon: 'üü†'}
    ];
    
    locations.forEach((loc, index) => {
        setTimeout(() => {
            let color = loc.type === 'farmer' ? '#2ecc71' : loc.type === 'buyer' ? '#3498db' : '#e67e22';
            
            const icon = L.divIcon({
                html: `<div class="marker-pin" style="background: ${color}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4); position: relative; animation: markerDrop 0.5s ease-out, markerPulse 2s infinite;"></div>`,
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            let popupContent = `
                <div style="min-width: 200px; font-family: 'Poppins', sans-serif;">
                    <h4 style="margin: 0 0 8px 0; color: ${color}; font-size: 1.1rem;">
                        ${loc.icon} ${loc.name}
                    </h4>
                    <p style="margin: 4px 0; color: #666; font-size: 0.9rem;">
                        <i class="fas fa-map-marker-alt"></i> <strong>${loc.location}</strong>
                    </p>`;
            
            if (loc.type === 'farmer') {
                popupContent += `<p style="margin: 4px 0; color: #2ecc71;"><i class="fas fa-seedling"></i> <strong>Crops:</strong> ${loc.crop}</p>`;
            } else if (loc.type === 'buyer') {
                popupContent += `<p style="margin: 4px 0; color: #3498db;"><i class="fas fa-shopping-cart"></i> <strong>Buying:</strong> ${loc.demand}</p>`;
            } else if (loc.type === 'warehouse') {
                popupContent += `<p style="margin: 4px 0; color: #e67e22;"><i class="fas fa-warehouse"></i> <strong>Capacity:</strong> ${loc.capacity}</p>`;
            }
            
            popupContent += `</div>`;
            
            const marker = L.marker([loc.lat, loc.lng], {icon: icon})
                .addTo(map)
                .bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });
            
            marker.on('click', function() {
                map.flyTo([loc.lat, loc.lng], 10, {
                    duration: 1.5,
                    easeLinearity: 0.25
                });
            });
            
            markers.push({marker: marker, data: loc});
        }, index * 80);
    });
    
    setTimeout(() => {
        map.invalidateSize();
        console.log('Map fully initialized with', markers.length, 'markers');
    }, 1000);
    
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map').innerHTML = `
            <div style="text-align: center; padding: 200px 20px; color: #e74c3c;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem;"></i>
                <p style="margin-top: 1rem; font-weight: 600;">Error loading map</p>
                <p style="font-size: 0.9rem; color: #666;">${error.message}</p>
                <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1.5rem; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reload Page
                </button>
            </div>
        `;
    }
}

function searchMap() {
    const searchTerm = document.getElementById('mapSearch').value.toLowerCase().trim();
    let foundMarkers = [];
    
    markers.forEach(({marker, data}) => {
        const matchesSearch = !searchTerm || 
            data.name.toLowerCase().includes(searchTerm) ||
            data.type.toLowerCase().includes(searchTerm) ||
            (data.location && data.location.toLowerCase().includes(searchTerm)) ||
            (data.crop && data.crop.toLowerCase().includes(searchTerm)) ||
            (data.demand && data.demand.toLowerCase().includes(searchTerm)) ||
            (data.capacity && data.capacity.toLowerCase().includes(searchTerm));
        
        if (matchesSearch) {
            marker.setOpacity(1);
            foundMarkers.push({marker, data});
            
            if (searchTerm && foundMarkers.length === 1) {
                setTimeout(() => {
                    map.flyTo(marker.getLatLng(), 10, {
                        duration: 1.5,
                        easeLinearity: 0.25
                    });
                    marker.openPopup();
                }, 300);
            }
        } else {
            marker.setOpacity(0.3);
            marker.closePopup();
        }
    });
    
    if (searchTerm && foundMarkers.length > 1) {
        const bounds = L.latLngBounds(foundMarkers.map(({marker}) => marker.getLatLng()));
        setTimeout(() => {
            map.flyToBounds(bounds, {
                padding: [50, 50],
                duration: 1.5,
                easeLinearity: 0.25
            });
        }, 300);
    }
    
    if (!searchTerm) {
        map.flyTo([20.5937, 78.9629], 5, {
            duration: 1.5,
            easeLinearity: 0.25
        });
    }
}

function toggleChat() {
    const chatBox = document.getElementById('chatBox');
    const toggle = document.getElementById('chatToggle');
    if (chatBox.style.display === 'none') {
        chatBox.style.display = 'block';
        toggle.className = 'fas fa-chevron-down';
    } else {
        chatBox.style.display = 'none';
        toggle.className = 'fas fa-chevron-up';
    }
}

function renderPriceData(predictions) {
    let priceTable = `<h4 style="margin-top: 1rem;">${getTranslation('price_forecast')}</h4><table style="width: 100%; border-collapse: collapse;">`;
    priceTable += `<tr style="background: #2ecc71; color: white;"><th style="padding: 0.5rem;">${getTranslation('date')}</th><th style="padding: 0.5rem;">${getTranslation('price_per_quintal')}</th></tr>`;
    predictions.forEach((pred, idx) => {
        const bg = idx % 2 === 0 ? '#f9f9f9' : 'white';
        priceTable += `<tr style="background: ${bg};"><td style="padding: 0.5rem; border: 1px solid #ddd;">${pred.date}</td><td style="padding: 0.5rem; border: 1px solid #ddd;">‚Çπ${pred.price.toFixed(2)}</td></tr>`;
    });
    priceTable += '</table>';
    document.getElementById('priceData').innerHTML = priceTable;
}

function renderAdvisory(advisory) {
    document.getElementById('advisoryContent').innerHTML = `
        <div class="alert alert-success">
            <strong><i class="fas fa-cloud-sun"></i> ${getTranslation('weather')}:</strong> ${advisory.weather}
        </div>
        <div class="alert alert-warning">
            <strong><i class="fas fa-bug"></i> ${getTranslation('pest_risk')}:</strong> ${advisory.pest_risk}
        </div>
        <div class="alert alert-info">
            <strong><i class="fas fa-seedling"></i> ${getTranslation('sowing_time')}:</strong> ${advisory.sowing_time}
        </div>
        <div class="alert alert-info">
            <strong><i class="fas fa-tractor"></i> ${getTranslation('harvest_time')}:</strong> ${advisory.harvest_time}
        </div>
        <div class="alert alert-success">
            <strong><i class="fas fa-lightbulb"></i> ${getTranslation('tip')}:</strong> ${advisory.tips}
        </div>
    `;
}

async function predictPrice() {
    const cropType = document.getElementById('cropType').value;
    
    try {
        const response = await fetch('/api/predict-price', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({crop_type: cropType})
        });
        
        const data = await response.json();
        currentPredictions = data.predictions;
        window.currentAdvisory = data.advisory;
        
        document.getElementById('priceChart').innerHTML = `
            <img src="data:image/png;base64,${data.chart}" style="width: 100%; border-radius: 8px;" alt="${getTranslation('price_prediction_title')}">
        `;
        
        renderPriceData(data.predictions);
        renderAdvisory(data.advisory);
        
        speak(`The predicted price for ${cropType} is ${data.predictions[0].price} rupees per quintal`);
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to fetch predictions. Please try again.');
    }
}

async function sellCrop() {
    const farmerName = document.getElementById('farmerName').value;
    const cropType = document.getElementById('sellCropType').value;
    const quantity = parseFloat(document.getElementById('quantity').value);
    const price = parseFloat(document.getElementById('price').value);
    
    if (!farmerName || !quantity || !price) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        const response = await fetch('/api/sell-crop', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                farmer_name: farmerName,
                crop_type: cropType,
                quantity: quantity,
                price: price
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('sellResult').innerHTML = `
                <div class="alert alert-success">
                    <strong><i class="fas fa-check-circle"></i> Success!</strong> 
                    ${data.message}<br>
                    <strong>Block Hash:</strong> ${data.block_hash.substring(0, 16)}...
                </div>
            `;
            
            if (data.badges && data.badges.length > 0) {
                let badgesHTML = '<h4>Congratulations! Your badges:</h4><div>';
                data.badges.forEach(badge => {
                    badgesHTML += `<span class="badge badge-success">${badge}</span>`;
                });
                badgesHTML += '</div>';
                document.getElementById('badgesContainer').innerHTML = badgesHTML;
                speak('Congratulations! You earned new badges');
            }
            
            speak('Transaction successful. Your crop has been recorded on the blockchain');
            
            document.getElementById('farmerName').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('price').value = '';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to record transaction. Please try again.');
    }
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.innerHTML += `
        <div style="margin-bottom: 1rem; text-align: right;">
            <strong>You:</strong> ${message}
        </div>
    `;
    
    input.value = '';
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        });
        
        const data = await response.json();
        
        messagesDiv.innerHTML += `
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>AI Assistant:</strong> ${data.response}
            </div>
        `;
        
        speak(data.response);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (error) {
        console.error('Error:', error);
    }
}

window.onload = function() {
    console.log('=== FARMER DASHBOARD LOADING ===');
    predictPrice();
    initVoice();
    console.log('=== DASHBOARD LOADED ===');
    console.log('Leaflet available at page load:', typeof L !== 'undefined');
    
    // Initialize map after a short delay to ensure all scripts are ready
    setTimeout(() => {
        console.log('Attempting to initialize map, Leaflet available:', typeof L !== 'undefined');
        if (typeof L !== 'undefined') {
            console.log('Initializing map...');
            const mapDiv = document.getElementById('map');
            if (mapDiv) {
                console.log('Map div found, height:', mapDiv.offsetHeight, 'width:', mapDiv.offsetWidth);
                try {
                    initMap();
                    console.log('Map initialized successfully');
                } catch (error) {
                    console.error('Error during map initialization:', error);
                }
            } else {
                console.error('Map div not found!');
            }
        } else {
            console.error('Leaflet library not available');
            document.getElementById('map').innerHTML = `
                <div style="text-align: center; padding: 100px 20px; color: #e74c3c;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem;"></i>
                    <p style="margin-top: 1rem; font-weight: 600;">Map library failed to load</p>
                    <p style="font-size: 0.9rem; color: #666;">Please reload the page to try again.</p>
                    <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> Reload Page
                    </button>
                </div>
            `;
        }
    }, 500);
};
</script>
{% endblock %}
