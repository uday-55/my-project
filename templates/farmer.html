{% extends "base.html" %}

{% block title %}Farmer Dashboard - Oilseed Platform{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .language-selector {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .voice-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .voice-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .voice-btn.listening {
        background: #e74c3c;
        color: white;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    #map {
        height: 500px;
        border-radius: 12px;
        margin-top: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .map-search {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .map-legend {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1.5rem;
        font-weight: 600;
    }
    
    .legend-marker {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="language-selector">
    <label style="margin-right: 0.5rem; font-weight: 600;">
        <i class="fas fa-language"></i> Language:
    </label>
    <select id="languageSelect" onchange="changeLanguage()" class="form-control" style="display: inline-block; width: auto;">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
    </select>
</div>

<h1 style="color: #2ecc71; margin-bottom: 2rem;">
    <i class="fas fa-tractor"></i> <span data-translate="farmer_dashboard">Farmer Dashboard</span>
</h1>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <i class="fas fa-chart-line"></i> <span data-translate="ai_price_predictor">AI Price Predictor</span>
            <button onclick="toggleVoice()" class="voice-btn" id="voiceBtn" style="float: right; font-size: 0.9rem;">
                <i class="fas fa-microphone"></i> <span data-translate="voice_control">Voice Control</span>
            </button>
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="select_crop">Select Crop Type</label>
            <select id="cropType" class="form-control">
                <option value="soybean" data-translate="soybean">Soybean</option>
                <option value="groundnut" data-translate="groundnut">Groundnut</option>
                <option value="mustard" data-translate="mustard">Mustard</option>
                <option value="sunflower" data-translate="sunflower">Sunflower</option>
            </select>
        </div>
        <button onclick="predictPrice()" class="btn btn-primary">
            <i class="fas fa-brain"></i> <span data-translate="predict_prices">Predict Prices</span>
        </button>
        <div class="voice-controls">
            <div id="voiceStatus" style="color: #666; font-size: 0.9rem;"></div>
        </div>
        <div id="priceChart" style="margin-top: 2rem;"></div>
        <div id="priceData" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-cloud-sun"></i> <span data-translate="crop_advisory">Crop Advisory</span>
        </div>
        <div id="advisoryContent">
            <p style="color: #666;" data-translate="select_crop_info">Select a crop and click "Predict Prices" to see advisory information</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-dollar-sign"></i> <span data-translate="sell_crop">Sell Your Crop</span>
    </div>
    <div class="grid grid-2">
        <div class="form-group">
            <label class="form-label" data-translate="your_name">Your Name</label>
            <input type="text" id="farmerName" class="form-control" placeholder="Enter your name">
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="crop_type">Crop Type</label>
            <select id="sellCropType" class="form-control">
                <option value="soybean">Soybean</option>
                <option value="groundnut">Groundnut</option>
                <option value="mustard">Mustard</option>
                <option value="sunflower">Sunflower</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="quantity">Quantity (kg)</label>
            <input type="number" id="quantity" class="form-control" placeholder="Enter quantity" min="0">
        </div>
        <div class="form-group">
            <label class="form-label" data-translate="price">Price (‚Çπ/quintal)</label>
            <input type="number" id="price" class="form-control" placeholder="Enter price" min="0">
        </div>
    </div>
    <button onclick="sellCrop()" class="btn btn-primary">
        <i class="fas fa-shopping-cart"></i> <span data-translate="sell_crop_btn">Sell Crop</span>
    </button>
    <div id="sellResult" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-trophy"></i> <span data-translate="your_badges">Your Badges</span>
    </div>
    <div id="badgesContainer">
        <p style="color: #666;" data-translate="earn_badges">Complete transactions to earn badges!</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-map-marked-alt"></i> <span data-translate="marketplace_map">Marketplace Map - Find Farmers, Buyers & Warehouses</span>
    </div>
    <div class="map-search">
        <input type="text" id="mapSearch" class="form-control" placeholder="Search for farms, buyers, or warehouses..." onkeyup="searchMap()">
    </div>
    <div id="map"></div>
    <div class="map-legend">
        <div class="legend-item">
            <div class="legend-marker" style="background: #2ecc71;"></div>
            <span data-translate="farmers">üü¢ Farmers</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #3498db;"></div>
            <span data-translate="buyers">üîµ Buyers</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #e67e22;"></div>
            <span data-translate="warehouses">üü† Marketplaces/Warehouses</span>
        </div>
    </div>
</div>

<div class="card" style="position: fixed; bottom: 20px; right: 20px; width: 350px; max-height: 500px; z-index: 999; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
    <div class="card-header" style="cursor: pointer;" onclick="toggleChat()">
        <i class="fas fa-robot"></i> <span data-translate="ai_assistant">AI Assistant</span>
        <span style="float: right;"><i class="fas fa-chevron-down" id="chatToggle"></i></span>
    </div>
    <div id="chatBox" style="display: block;">
        <div id="chatMessages" style="height: 250px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9;">
            <div class="alert alert-info">
                <strong data-translate="ai_assistant">AI Assistant:</strong> <span data-translate="ai_greeting">Hello! I'm here to help with oilseed farming, pricing, weather, and more. Ask me anything!</span>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="chatInput" class="form-control" placeholder="Ask about prices, weather, pests..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button onclick="voiceChat()" class="btn btn-secondary">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>
</div>

<div style="margin-bottom: 2rem;">
    <a href="/download-report?type=farmer" class="btn btn-secondary">
        <i class="fas fa-download"></i> <span data-translate="download_report">Download My Report (PDF)</span>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let currentPredictions = [];
let map;
let markers = [];
let currentLanguage = 'en';
let recognition;
let isListening = false;

const translations = {
    en: {
        farmer_dashboard: "Farmer Dashboard",
        ai_price_predictor: "AI Price Predictor",
        voice_control: "Voice Control",
        select_crop: "Select Crop Type",
        predict_prices: "Predict Prices",
        crop_advisory: "Crop Advisory",
        select_crop_info: "Select a crop and click 'Predict Prices' to see advisory information",
        sell_crop: "Sell Your Crop",
        your_name: "Your Name",
        crop_type: "Crop Type",
        quantity: "Quantity (kg)",
        price: "Price (‚Çπ/quintal)",
        sell_crop_btn: "Sell Crop",
        your_badges: "Your Badges",
        earn_badges: "Complete transactions to earn badges!",
        marketplace_map: "Marketplace Map - Find Farmers, Buyers & Warehouses",
        farmers: "üü¢ Farmers",
        buyers: "üîµ Buyers",
        warehouses: "üü† Marketplaces/Warehouses",
        ai_assistant: "AI Assistant",
        ai_greeting: "Hello! I'm here to help with oilseed farming, pricing, weather, and more. Ask me anything!",
        download_report: "Download My Report (PDF)",
        soybean: "Soybean",
        groundnut: "Groundnut",
        mustard: "Mustard",
        sunflower: "Sunflower"
    },
    hi: {
        farmer_dashboard: "‡§ï‡§ø‡§∏‡§æ‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
        ai_price_predictor: "‡§è‡§Ü‡§à ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§ï‡•ç‡§§‡§æ",
        voice_control: "‡§Ü‡§µ‡§æ‡§ú ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£",
        select_crop: "‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç",
        predict_prices: "‡§ï‡•Ä‡§Æ‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡•á‡§Ç",
        crop_advisory: "‡§´‡§∏‡§≤ ‡§∏‡§≤‡§æ‡§π",
        select_crop_info: "‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§≤‡§æ‡§π ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è '‡§ï‡•Ä‡§Æ‡§§‡•ã‡§Ç ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡•á‡§Ç' ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç",
        sell_crop: "‡§Ö‡§™‡§®‡•Ä ‡§´‡§∏‡§≤ ‡§¨‡•á‡§ö‡•á‡§Ç",
        your_name: "‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ",
        crop_type: "‡§´‡§∏‡§≤ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
        quantity: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ï‡§ø‡§≤‡•ã)",
        price: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤)",
        sell_crop_btn: "‡§´‡§∏‡§≤ ‡§¨‡•á‡§ö‡•á‡§Ç",
        your_badges: "‡§Ü‡§™‡§ï‡•á ‡§¨‡•à‡§ú",
        earn_badges: "‡§¨‡•à‡§ú ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç!",
        marketplace_map: "‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞ - ‡§ï‡§ø‡§∏‡§æ‡§®, ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞ ‡§î‡§∞ ‡§ó‡•ã‡§¶‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç",
        farmers: "üü¢ ‡§ï‡§ø‡§∏‡§æ‡§®",
        buyers: "üîµ ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞",
        warehouses: "üü† ‡§¨‡§æ‡§ú‡§æ‡§∞/‡§ó‡•ã‡§¶‡§æ‡§Æ",
        ai_assistant: "‡§è‡§Ü‡§à ‡§∏‡§π‡§æ‡§Ø‡§ï",
        ai_greeting: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§§‡§ø‡§≤‡§π‡§® ‡§ï‡•Ä ‡§ñ‡•á‡§§‡•Ä, ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£, ‡§Æ‡•å‡§∏‡§Æ ‡§î‡§∞ ‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§π‡•Ç‡§Å‡•§ ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç!",
        download_report: "‡§Æ‡•á‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (PDF)",
        soybean: "‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®",
        groundnut: "‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä",
        mustard: "‡§∏‡§∞‡§∏‡•ã‡§Ç",
        sunflower: "‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä"
    },
    te: {
        farmer_dashboard: "‡∞∞‡±à‡∞§‡±Å ‡∞°‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç",
        ai_price_predictor: "AI ‡∞ß‡∞∞ ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ",
        voice_control: "‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞®‡∞ø‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞£",
        select_crop: "‡∞™‡∞Ç‡∞ü ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø",
        predict_prices: "‡∞ß‡∞∞‡∞≤‡∞®‡±Å ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ ‡∞µ‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
        crop_advisory: "‡∞™‡∞Ç‡∞ü ‡∞∏‡∞≤‡∞π‡∞æ",
        ai_assistant: "AI ‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å",
        download_report: "‡∞®‡∞æ ‡∞®‡∞ø‡∞µ‡±á‡∞¶‡∞ø‡∞ï‡∞®‡±Å ‡∞°‡±å‡∞®‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø (PDF)"
    },
    ta: {
        farmer_dashboard: "‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ‡Æø ‡Æü‡Ææ‡Æ∑‡Øç‡Æ™‡Øã‡Æ∞‡Øç‡Æü‡ØÅ",
        ai_price_predictor: "AI ‡Æµ‡Æø‡Æ≤‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
        voice_control: "‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç ‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ØÅ",
        select_crop: "‡Æ™‡ÆØ‡Æø‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
        predict_prices: "‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
        crop_advisory: "‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà",
        ai_assistant: "AI ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç",
        download_report: "‡Æé‡Æ©‡Æ§‡ØÅ ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (PDF)"
    }
};

function changeLanguage() {
    currentLanguage = document.getElementById('languageSelect').value;
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            element.textContent = translations[currentLanguage][key];
        }
    });
}

function initVoice() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript.toLowerCase();
            document.getElementById('voiceStatus').textContent = `Heard: "${transcript}"`;
            processVoiceCommand(transcript);
        };
        
        recognition.onerror = function(event) {
            document.getElementById('voiceStatus').textContent = 'Error: ' + event.error;
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
        };
        
        recognition.onend = function() {
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
        };
    } else {
        document.getElementById('voiceStatus').textContent = 'Voice recognition not supported';
    }
}

function toggleVoice() {
    if (!recognition) {
        initVoice();
    }
    
    if (isListening) {
        recognition.stop();
        isListening = false;
        document.getElementById('voiceBtn').classList.remove('listening');
        document.getElementById('voiceStatus').textContent = '';
    } else {
        recognition.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
        recognition.start();
        isListening = true;
        document.getElementById('voiceBtn').classList.add('listening');
        document.getElementById('voiceStatus').textContent = 'Listening...';
    }
}

function processVoiceCommand(command) {
    if (command.includes('soybean') || command.includes('‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®')) {
        document.getElementById('cropType').value = 'soybean';
        predictPrice();
    } else if (command.includes('groundnut') || command.includes('‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä')) {
        document.getElementById('cropType').value = 'groundnut';
        predictPrice();
    } else if (command.includes('mustard') || command.includes('‡§∏‡§∞‡§∏‡•ã‡§Ç')) {
        document.getElementById('cropType').value = 'mustard';
        predictPrice();
    } else if (command.includes('sunflower') || command.includes('‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä')) {
        document.getElementById('cropType').value = 'sunflower';
        predictPrice();
    } else if (command.includes('price') || command.includes('predict') || command.includes('‡§ï‡•Ä‡§Æ‡§§')) {
        predictPrice();
    } else {
        speak('Command not recognized. Try saying: soybean price, mustard price, or groundnut price');
    }
}

function voiceChat() {
    if (!recognition) initVoice();
    
    const voiceRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    voiceRecognition.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
    voiceRecognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('chatInput').value = transcript;
        sendMessage();
    };
    voiceRecognition.start();
}

function speak(text) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = currentLanguage === 'hi' ? 'hi-IN' : 'en-IN';
        speechSynthesis.speak(utterance);
    }
}

function initMap() {
    map = L.map('map').setView([20.5937, 78.9629], 5);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    const locations = [
        {type: 'farmer', name: 'Ram Kumar Farm', lat: 28.6139, lng: 77.2090, crop: 'Soybean, Mustard', icon: 'üü¢'},
        {type: 'farmer', name: 'Lakshmi Agro', lat: 19.0760, lng: 72.8777, crop: 'Groundnut', icon: 'üü¢'},
        {type: 'farmer', name: 'Suresh Organic Farm', lat: 13.0827, lng: 80.2707, crop: 'Sunflower', icon: 'üü¢'},
        {type: 'farmer', name: 'Ganesh Farms', lat: 17.3850, lng: 78.4867, crop: 'Soybean', icon: 'üü¢'},
        {type: 'farmer', name: 'Rajesh Crops', lat: 22.5726, lng: 88.3639, crop: 'Mustard', icon: 'üü¢'},
        {type: 'buyer', name: 'ABC Oil Mills', lat: 28.4595, lng: 77.0266, demand: 'All Oilseeds', icon: 'üîµ'},
        {type: 'buyer', name: 'Premium Processors', lat: 12.9716, lng: 77.5946, demand: 'Groundnut, Sunflower', icon: 'üîµ'},
        {type: 'buyer', name: 'Golden Oil Industries', lat: 23.0225, lng: 72.5714, demand: 'Soybean', icon: 'üîµ'},
        {type: 'warehouse', name: 'Central Warehouse Delhi', lat: 28.7041, lng: 77.1025, capacity: '5000 tonnes', icon: 'üü†'},
        {type: 'warehouse', name: 'Maharashtra Storage Hub', lat: 19.2183, lng: 72.9781, capacity: '8000 tonnes', icon: 'üü†'},
        {type: 'warehouse', name: 'South India Depot', lat: 13.0569, lng: 80.2425, capacity: '6000 tonnes', icon: 'üü†'},
        {type: 'warehouse', name: 'Telangana FPO Center', lat: 17.4474, lng: 78.3742, capacity: '4500 tonnes', icon: 'üü†'}
    ];
    
    locations.forEach((loc, index) => {
        setTimeout(() => {
            let color = loc.type === 'farmer' ? '#2ecc71' : loc.type === 'buyer' ? '#3498db' : '#e67e22';
            
            const icon = L.divIcon({
                html: `<div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                className: '',
                iconSize: [24, 24]
            });
            
            let popupContent = `<strong>${loc.name}</strong><br>`;
            if (loc.type === 'farmer') popupContent += `<em>Crops:</em> ${loc.crop}`;
            else if (loc.type === 'buyer') popupContent += `<em>Demand:</em> ${loc.demand}`;
            else if (loc.type === 'warehouse') popupContent += `<em>Capacity:</em> ${loc.capacity}`;
            
            const marker = L.marker([loc.lat, loc.lng], {icon: icon})
                .addTo(map)
                .bindPopup(popupContent);
            
            markers.push({marker: marker, data: loc});
        }, index * 100);
    });
}

function searchMap() {
    const searchTerm = document.getElementById('mapSearch').value.toLowerCase();
    
    markers.forEach(({marker, data}) => {
        const matchesSearch = !searchTerm || 
            data.name.toLowerCase().includes(searchTerm) ||
            (data.crop && data.crop.toLowerCase().includes(searchTerm)) ||
            (data.demand && data.demand.toLowerCase().includes(searchTerm));
        
        if (matchesSearch) {
            marker.setOpacity(1);
            if (searchTerm && matchesSearch) {
                marker.openPopup();
                map.setView(marker.getLatLng(), 8);
            }
        } else {
            marker.setOpacity(0.3);
        }
    });
}

function toggleChat() {
    const chatBox = document.getElementById('chatBox');
    const toggle = document.getElementById('chatToggle');
    if (chatBox.style.display === 'none') {
        chatBox.style.display = 'block';
        toggle.className = 'fas fa-chevron-down';
    } else {
        chatBox.style.display = 'none';
        toggle.className = 'fas fa-chevron-up';
    }
}

async function predictPrice() {
    const cropType = document.getElementById('cropType').value;
    
    try {
        const response = await fetch('/api/predict-price', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({crop_type: cropType})
        });
        
        const data = await response.json();
        currentPredictions = data.predictions;
        
        document.getElementById('priceChart').innerHTML = `
            <img src="data:image/png;base64,${data.chart}" style="width: 100%; border-radius: 8px;">
        `;
        
        let priceTable = '<h4 style="margin-top: 1rem;">7-Day Price Forecast</h4><table style="width: 100%; border-collapse: collapse;">';
        priceTable += '<tr style="background: #2ecc71; color: white;"><th style="padding: 0.5rem;">Date</th><th style="padding: 0.5rem;">Price (‚Çπ/quintal)</th></tr>';
        data.predictions.forEach((pred, idx) => {
            const bg = idx % 2 === 0 ? '#f9f9f9' : 'white';
            priceTable += `<tr style="background: ${bg};"><td style="padding: 0.5rem; border: 1px solid #ddd;">${pred.date}</td><td style="padding: 0.5rem; border: 1px solid #ddd;">‚Çπ${pred.price.toFixed(2)}</td></tr>`;
        });
        priceTable += '</table>';
        document.getElementById('priceData').innerHTML = priceTable;
        
        const advisory = data.advisory;
        document.getElementById('advisoryContent').innerHTML = `
            <div class="alert alert-success">
                <strong><i class="fas fa-cloud-sun"></i> Weather:</strong> ${advisory.weather}
            </div>
            <div class="alert alert-warning">
                <strong><i class="fas fa-bug"></i> Pest Risk:</strong> ${advisory.pest_risk}
            </div>
            <div class="alert alert-info">
                <strong><i class="fas fa-seedling"></i> Sowing Time:</strong> ${advisory.sowing_time}
            </div>
            <div class="alert alert-info">
                <strong><i class="fas fa-tractor"></i> Harvest Time:</strong> ${advisory.harvest_time}
            </div>
            <div class="alert alert-success">
                <strong><i class="fas fa-lightbulb"></i> Tip:</strong> ${advisory.tips}
            </div>
        `;
        
        speak(`The predicted price for ${cropType} is ${data.predictions[0].price} rupees per quintal`);
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to fetch predictions. Please try again.');
    }
}

async function sellCrop() {
    const farmerName = document.getElementById('farmerName').value;
    const cropType = document.getElementById('sellCropType').value;
    const quantity = parseFloat(document.getElementById('quantity').value);
    const price = parseFloat(document.getElementById('price').value);
    
    if (!farmerName || !quantity || !price) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        const response = await fetch('/api/sell-crop', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                farmer_name: farmerName,
                crop_type: cropType,
                quantity: quantity,
                price: price
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('sellResult').innerHTML = `
                <div class="alert alert-success">
                    <strong><i class="fas fa-check-circle"></i> Success!</strong> 
                    ${data.message}<br>
                    <strong>Block Hash:</strong> ${data.block_hash.substring(0, 16)}...
                </div>
            `;
            
            if (data.badges && data.badges.length > 0) {
                let badgesHTML = '<h4>Congratulations! Your badges:</h4><div>';
                data.badges.forEach(badge => {
                    badgesHTML += `<span class="badge badge-success">${badge}</span>`;
                });
                badgesHTML += '</div>';
                document.getElementById('badgesContainer').innerHTML = badgesHTML;
                speak('Congratulations! You earned new badges');
            }
            
            speak('Transaction successful. Your crop has been recorded on the blockchain');
            
            document.getElementById('farmerName').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('price').value = '';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to record transaction. Please try again.');
    }
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.innerHTML += `
        <div style="margin-bottom: 1rem; text-align: right;">
            <strong>You:</strong> ${message}
        </div>
    `;
    
    input.value = '';
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        });
        
        const data = await response.json();
        
        messagesDiv.innerHTML += `
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>AI Assistant:</strong> ${data.response}
            </div>
        `;
        
        speak(data.response);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (error) {
        console.error('Error:', error);
    }
}

window.onload = function() {
    predictPrice();
    initMap();
    initVoice();
};
</script>
{% endblock %}
